# СЕССИИ И СОЕДИНЕНИЯ    


## Содержание  
  
[Сессия](#Сессия)  
[Соединение](#Соединение)  
[Пул соединений](#Пул-соединений)  
[Сессия и объекты модели](#Сессия-и-объекты-модели)


----
## Сессия  
Это объект для работы с транзакциями и объектами внутри нее.  
Каждая сессия открывается в контексте конкретного HTTP-запроса, который обрабатывает приложение - сессия привязана к контексту запроса.  
  
Этапы жизненного цикла сессии:  
- Создание:   
- Работа: выполняются запросы, изменения, загрузка данных  
- Коммит или откат: commit() или rollback()  
- Закрытие: овобождаются ресурсы, соединение возвращается в пул  
- Удаление: сессия уничтожается  

ВАЖНО: закрытая сессия теряет соединение и освобождает ресурсы но сам объект сессии остается в памяти, и может быть повторно использован, но только в контексте того же самого HTTP-запроса.    
  
  
  
----
## Соединение  
Соединение (Connection) - это открытый канал между приложением и базой данных, по которому идут SQL-запросы и ответы.        
  
  
  
----
## Пул соединений  
Пул соединений (Connection Pool)     
Это набор открытых соединений, которые хранятся и переиспользуются для разных сессий и запросов, чтобы не открывать новое соединение каждый раз (это дорого).      
Любая сессия может воспользоваться свободным соединением из пула соединений.        
Если сводобных соединений нет, то для выполнения запроса будет создано новое соединение.       
Пул соединений имеет лимит открытых соденений. Если он достигнут, то запрос будет ждать освобождения соединения.        
Время жизни свободных соединений установлено где в настройках (по дефолту обычно 300 секунд).      



----
## Сессия и объекты модели  
Открытая сессия подразумевает, что объекты модели продолжают отслеживаться.    
  
Как это работает:    
  
1. Когда мы загружаем объекты из базы данных или добавляем новые объекты в сессию, sqlalchemy начинает отслеживать их состояние.    
    Если в объекты вносятся какие-либо изменения, то это фиксируется сессией.    
  
2. SQLAlchemy отслеживает состояния объектов используя статусы объектов:  

    - Transient: только что создан и не добавлен в сессию    
    - Pending: добавлен в сессию, но не сохранен в базу данных    
    - Persistent: загружен из базы данных или был добавлен в сессию и готов для сохранения    
    - Detached: остоединен от сессии и больше не отслеживается    
  
3. Коммит изменений.  
    Проверяются все объекты в состояниях Pending и Persistent и все изменения фиксируются в базе данных.  
